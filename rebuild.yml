- name: install {{ pkg }} build-dependencies
  shell: yes | mk-build-deps -ir "{{ pkg }}"
  become: yes

- name: debcheckout {{ pkg }}
  command: debcheckout "{{ pkg }}"
  register: debcheckout_result
  ignore_errors: yes

- name: fallback to apt source if debcheckout fails
  command: apt source "{{ pkg }}"
  when: "'checkout failed' in debcheckout_result.stderr"

- name: find source folder
  command: find . -maxdepth 1 -type d -name "{{ pkg }}*"
  register: source_folder

- name: build {{ pkg }}
  command: dpkg-buildpackage -uc -us -b
  args:
    chdir: "{{ source_folder.stdout_lines.0 }}"

- name: remove {{ pkg }} build dependencies
  apt:
    state: absent
    name: "{{ pkg }}-build-deps"
    autoremove: yes
  become: yes
