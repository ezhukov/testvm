---
- hosts: testvm

  tasks:

  - name: add source repository
    apt_repository:
      repo: deb-src http://httpredir.debian.org/debian sid main
      state: present
    become: yes

  - name: add en_US locale
    lineinfile:
      dest: /etc/locale.gen
      line: 'en_US.UTF-8 UTF-8'
    register: locale_added
    become: yes

  - name: re-generate locales
    command: locale-gen
    when: locale_added.changed
    become: yes

  - include: build.yml pkg={{package}}

  - name: install debs
    apt:
      deb: "{{ item }}_{{ version.stdout }}_all.deb"
    with_items: "{{ binaries.stdout_lines }}"
    become: yes

  - name: find {{ package }} reverse build dependencies
    command: build-rdeps --only-main --old --quiet {{item}}
    with_items: "{{ binaries.stdout_lines }}"
    register: build_rdeps_result

  - name: rebuild {{ package }} reverse build dependencies
    include: rdeps.yml
    static: no
    with_items: "{{ build_rdeps_result.results }}"
    loop_control:
      loop_var: rdeps
